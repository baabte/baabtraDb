db.system.js.save({_id:"fnEditCourseElement",value:function(e,l,t,n){var s=n.index,r=n.element,i="courseTimeline."+t+"."+l,o={};o[i]=r;var a=db.clnCourses.find({_id:e}).toArray(),m=a[0].courseTimeline[t][l][s].order,u=0,v=0,c=0,y=a[0].courseTimeline[t][l],k=0;a[0].totalMark&&(u=a[0].totalMark);for(T in y)for(k=0;k<y[T].elements.length;k++)null!=y[T].elements[k]&&("question-viewer"==y[T].elements[k].type||"question-group-viewer"==y[T].elements[k].type||"assignment-question-viewer"==y[T].elements[k].type)&&(v+=y[T].elements[k].value.mark.totalMark);for(k=0;k<r.elements.length;k++)null!=y[T].elements[k]&&("question-viewer"==r.elements[k].type||"question-group-viewer"==r.elements[k].type||"assignment-question-viewer"==r.elements[k].type)&&(c+=r.elements[k].value.mark.totalMark);var p=r.syllabus.key.split("."),d=a[0].syllabus;for(var i in p)d=d[p[i]];d.element||(d.element=[]),d.element.push(t+"."+l+"."+s),p=a[0].courseTimeline[t][l][s].syllabus.key.split("."),d=a[0].syllabus;for(var i in p)d=d[p[i]];d.element||(d.element=[]);for(var T in d.element)d.element[T]==t+"."+l+"."+s&&d.element.splice(T,1);var f=0;return a[0].courseTimeline[t].totalMark&&(f=a[0].courseTimeline[t].totalMark),a[0].courseTimeline[t][l][s]=r,a[0].courseTimeline[t][l][s].order=m,a[0].courseTimeline[t][l][s].totalMark=c,a[0].totalMark=u+(c-v),a[0].courseTimeline[t].totalMark=f+(c-v),db.clnCourses.save(a[0]),a}});

db.system.js.save({_id:"fnRemoveCourseElement",value:function(e,r,l,s){var n="courseTimeline."+l+"."+r,i={};i[n]=s;var d={};d[n]=1,d.syllabus=1,d._id=0;var o=db.clnCourses.findOne({_id:e},d),t=1*o.courseTimeline[l][r][s].order,u=o.courseTimeline[l][r][s].elements,a=0;for(indexKey in u)("question-viewer"==u[indexKey].type||"question-group-viewer"==u[indexKey].type||"assignment-question-viewer"==u[indexKey].type)&&(a+=u[indexKey].value.mark.totalMark);var m=o.courseTimeline[l][r][s].syllabus.key.split(".");db.clnCourses.update({_id:e},{$pop:i});var c=db.clnCourses.findOne({_id:e});if(!c.courseTimeline[l][r].length){b=c.courseTimeline[l][r];var y={};y[n]=1,db.clnCourses.update({_id:e},{$unset:y}),c=db.clnCourses.findOne({_id:e}),0==Object.keys(c.courseTimeline[l]).length&&(y={},y["courseTimeline."+l]=1,db.clnCourses.update({_id:e},{$unset:y}),b=y)}var O=db.clnCourses.findOne({_id:e});delete O.elementOrder[t],O.totalMark=O.totalMark-a,O.courseTimeline[l].totalMark=O.courseTimeline[l].totalMark-a;for(order in O.elementOrder)if(order=1*order,order>t&&O.elementOrder[order]){var v=O.elementOrder[order].split("."),f=v[0],p=v[1],T=v[2];t!=order&&(O.courseTimeline[f][p][T].order=order-1,O.elementOrder[order-1]=O.elementOrder[order]),delete O.elementOrder[order]}syllabusObj=O.syllabus;for(var n in m)syllabusObj=syllabusObj[m[n]];syllabusObj.element||(syllabusObj.element=[]);for(var j in syllabusObj.element)syllabusObj.element[j]==l+"."+r+"."+s&&syllabusObj.element.splice(j,1);return db.clnCourses.save(O),O.elementOrder}});
